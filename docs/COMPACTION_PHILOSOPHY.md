# Context Compaction è®¾è®¡å“²å­¦

## ä¸ºä»€ä¹ˆé‡‡ç”¨ OpenCode çš„æ–¹å¼ï¼Ÿ

æ„Ÿè°¢ç”¨æˆ·çš„æ•é”è§‚å¯Ÿï¼ç»è¿‡æ·±å…¥ç ”ç©¶ OpenCode çš„å®ç°ï¼Œæˆ‘ä»¬ç†è§£äº†å…¶"ç®€å•å°±æ˜¯ç¾"çš„è®¾è®¡å“²å­¦ã€‚

## è®¾è®¡å¯¹æ¯”

### âŒ å¤æ‚æ–¹å¼ï¼ˆè¢«åŠ¨å¼ï¼‰
```python
# ç­‰åˆ°æº¢å‡ºæ‰å¤„ç†
if is_overflow():
    if enable_prune:
        prune()  # å°è¯•è½»é‡æ¸…ç†
        if still_overflow():
            compact()  # é‡å‹å‹ç¼©
    else:
        compact()
```

**é—®é¢˜**ï¼š
- é€»è¾‘å¤æ‚ï¼Œå¤šå±‚åµŒå¥—
- è¢«åŠ¨å¼ - ç­‰åˆ°é—®é¢˜å‡ºç°æ‰å¤„ç†
- æ¡ä»¶åˆ¤æ–­å¤š

### âœ… OpenCode æ–¹å¼ï¼ˆä¸»åŠ¨å¼ï¼‰
```python
# æ¯æ¬¡éƒ½ä¸»åŠ¨ç»´æŠ¤ï¼ˆè½»é‡ï¼‰
prune()  # æœ‰å¤šé‡ä¿æŠ¤ï¼Œé€šå¸¸å¾ˆå¿«è¿”å›

# çœŸæ­£æº¢å‡ºæ—¶æ‰å‹ç¼©ï¼ˆç½•è§ï¼‰
if is_overflow():
    compact()  # é‡å‹æ“ä½œ
```

**ä¼˜ç‚¹**ï¼š
- æç®€é€»è¾‘ï¼Œæ˜“äºç†è§£
- ä¸»åŠ¨ç»´æŠ¤ - æŒç»­ä¿æŒä¸Šä¸‹æ–‡æ¸…æ´
- åˆ†ç¦»å…³æ³¨ç‚¹ï¼špruneï¼ˆæ—¥å¸¸ç»´æŠ¤ï¼‰vs compactï¼ˆé‡å‹æ•‘æ´ï¼‰

## Prune çš„å¤šé‡ä¿æŠ¤æœºåˆ¶

OpenCode çš„ prune è®¾è®¡éå¸¸å·§å¦™ï¼Œæœ‰ **5 é‡ä¿æŠ¤**ç¡®ä¿å®‰å…¨ï¼š

```python
def prune_tool_results(messages):
    """
    æ‰«ææ–¹å‘ï¼šä»æ–°åˆ°æ—§ï¼ˆbackwardsï¼‰

    ä¿æŠ¤ 1: æœ€è¿‘ 2 ä¸ªç”¨æˆ·å›åˆ
    â”œâ”€â”€ æ°¸è¿œä¸å¤„ç†æœ€è¿‘ 2 ä¸ª user turn
    â””â”€â”€ ä¿è¯å½“å‰ä¸Šä¸‹æ–‡å®Œæ•´

    ä¿æŠ¤ 2: æœ€è¿‘ 40k tokens
    â”œâ”€â”€ ç´¯è®¡æœ€è¿‘ 40k tokens çš„å·¥å…·è¾“å‡º
    â””â”€â”€ åªåˆ é™¤è¶…è¿‡ 40k ä¹‹å¤–çš„æ—§è¾“å‡º

    ä¿æŠ¤ 3: é˜ˆå€¼æ£€æŸ¥ (20k)
    â”œâ”€â”€ åªæœ‰ç´¯è®¡ > 20k tokens æ‰æ‰§è¡Œ
    â””â”€â”€ é¿å…é¢‘ç¹æ— æ„ä¹‰çš„åˆ é™¤

    ä¿æŠ¤ 4: é‡åˆ°æ‘˜è¦åœæ­¢
    â”œâ”€â”€ çœ‹åˆ° [Conversation Summary] å°±åœæ­¢
    â””â”€â”€ ä¸é‡å¤å¤„ç†å·²å‹ç¼©çš„å†…å®¹

    ä¿æŠ¤ 5: å·² prune æ ‡è®°
    â”œâ”€â”€ æ£€æµ‹ [Output pruned] å ä½ç¬¦
    â””â”€â”€ é¿å…é‡å¤åˆ é™¤
    """
```

## ä¸ºä»€ä¹ˆæ¯æ¬¡éƒ½è°ƒç”¨ Prune æ˜¯å®‰å…¨çš„ï¼Ÿ

### 1. **æˆæœ¬æä½**

```python
# å…¸å‹åœºæ™¯ï¼šçŸ­å¯¹è¯ï¼ˆ2-3 å›åˆï¼‰
def prune():
    # æ‰«ææ¶ˆæ¯...
    # æœ€è¿‘ 2 å›åˆ â†’ è·³è¿‡ï¼ˆä¿æŠ¤ 1ï¼‰
    # æ²¡æœ‰æ—§çš„å·¥å…·è¾“å‡º â†’ ç«‹å³è¿”å›
    # æˆæœ¬ï¼šå‡ ä¸ª if åˆ¤æ–­ + å‡ æ¬¡å¾ªç¯
    # æ—¶é—´ï¼š< 1ms
```

### 2. **å¤§éƒ¨åˆ†æ—¶å€™ä»€ä¹ˆéƒ½ä¸åš**

```
å¯¹è¯è½®æ•°     å·¥å…·è¾“å‡º     Prune è¡Œä¸º
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1-2 å›åˆ     ä»»æ„         è·³è¿‡ï¼ˆä¿æŠ¤ 1ï¼‰
3-5 å›åˆ     < 40k       ä»€ä¹ˆéƒ½ä¸åˆ 
6-10 å›åˆ    < 40k       ä»€ä¹ˆéƒ½ä¸åˆ 
é•¿å¯¹è¯       > 60k       åˆ é™¤ 20k æ—§è¾“å‡º
è¶…é•¿å¯¹è¯     > 100k      åˆ é™¤ 60k æ—§è¾“å‡º
```

### 3. **åªåœ¨çœŸæ­£éœ€è¦æ—¶æ‰å·¥ä½œ**

```python
# ç¤ºä¾‹ï¼š10 å›åˆå¯¹è¯
æ¶ˆæ¯å†å²ï¼ˆä»æ–°åˆ°æ—§ï¼‰ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Turn 10: User â†’ Assistant â†’ Tool[3k]  â† ä¿æŠ¤ï¼ˆæœ€è¿‘ 2 å›åˆï¼‰
Turn 9:  User â†’ Assistant â†’ Tool[5k]  â† ä¿æŠ¤ï¼ˆæœ€è¿‘ 2 å›åˆï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Turn 8:  User â†’ Assistant â†’ Tool[8k]  â† ç´¯è®¡ 16k
Turn 7:  User â†’ Assistant â†’ Tool[12k] â† ç´¯è®¡ 28k
Turn 6:  User â†’ Assistant â†’ Tool[15k] â† ç´¯è®¡ 43k âœ“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Turn 5:  User â†’ Assistant â†’ Tool[20k] â† ä¼šè¢« prune
Turn 4:  User â†’ Assistant â†’ Tool[25k] â† ä¼šè¢« prune
Turn 3:  User â†’ Assistant â†’ Tool[30k] â† ä¼šè¢« prune
...

Prune ç»“æœï¼šåˆ é™¤ Turn 3-5 çš„å·¥å…·è¾“å‡ºï¼ˆ75k tokensï¼‰
ä¿ç•™ï¼šTurn 6-10ï¼ˆæœ€è¿‘ 63k tokensï¼‰
```

## ä¸»åŠ¨ç»´æŠ¤ vs è¢«åŠ¨è¡¥æ•‘

### ä¸»åŠ¨ç»´æŠ¤ï¼ˆOpenCodeï¼‰
```python
# æ¯æ¬¡å¯¹è¯éƒ½æ¸…ç†
prune()  # åƒå®šæœŸæ‰“æ‰«æˆ¿é—´ï¼Œä¿æŒæ¸…æ´
â†’ ä¸Šä¸‹æ–‡å§‹ç»ˆå¤„äºè‰¯å¥½çŠ¶æ€
â†’ å¾ˆå°‘éœ€è¦é‡å‹å‹ç¼©
```

### è¢«åŠ¨è¡¥æ•‘ï¼ˆä¹‹å‰çš„å®ç°ï¼‰
```python
# ç­‰åˆ°æº¢å‡ºæ‰å¤„ç†
if overflow:
    prune()  # åƒç­‰æˆ¿é—´å †æ»¡äº†æ‰å¤§æ‰«é™¤
    if still_overflow:
        compact()  # æ‰”æ‰ä¸€åŠä¸œè¥¿
```

## å®ç°ç»†èŠ‚

### Prune çš„å·¥ä½œæ–¹å¼
```python
def prune_tool_results(messages: List[Message]):
    """ä»åå¾€å‰æ‰«æï¼Œä¿æŠ¤æœ€è¿‘çš„å†…å®¹"""

    # 1. æ‰¾åˆ°ä¿æŠ¤è¾¹ç•Œï¼ˆæœ€è¿‘ 2 ä¸ª user turnï¼‰
    protected_index = find_recent_turns(messages, count=2)

    # 2. ç´¯è®¡å·¥å…·è¾“å‡º tokens
    total = 0
    for msg in messages[protected_index:0:-1]:  # ä»ä¿æŠ¤è¾¹ç•Œå¾€å‰
        if isinstance(msg, ToolResult):
            total += estimate_tokens(msg)

            # 3. è¶…è¿‡ 40kï¼Œæ ‡è®°ä¸ºå¯åˆ é™¤
            if total > 40_000:
                mark_for_prune(msg)

    # 4. åªæœ‰ç´¯è®¡ > 20k æ‰çœŸæ­£æ‰§è¡Œ
    if sum(marked) > 20_000:
        execute_prune()
```

### Compact çš„å·¥ä½œæ–¹å¼
```python
def compact_messages(messages: List[Message], summary: str):
    """é‡å‹æ“ä½œï¼šç”Ÿæˆæ‘˜è¦ï¼Œæ›¿æ¢æ—§æ¶ˆæ¯"""

    # 1. ç”Ÿæˆæ‘˜è¦ï¼ˆè°ƒç”¨ LLMï¼Œæ˜‚è´µï¼‰
    summary = llm.generate_summary(messages)

    # 2. ä¿ç•™æœ€è¿‘ 2 ä¸ªå›åˆ
    recent = messages[-4:]  # 2 user turns â‰ˆ 4 messages

    # 3. ç”¨æ‘˜è¦æ›¿æ¢æ—§æ¶ˆæ¯
    return [SummaryMessage(summary)] + recent
```

## é…ç½®é€‰é¡¹

```json
{
  "auto_compact": true,  // å¯ç”¨è‡ªåŠ¨å‹ç¼©
  "enable_prune": true   // å¯ç”¨ä¸»åŠ¨ç»´æŠ¤ï¼ˆæ¨èï¼‰
}
```

**æ¨èé…ç½®**ï¼šä¸¤ä¸ªéƒ½å¼€å¯
- `enable_prune=true` â†’ ä¸»åŠ¨ç»´æŠ¤ï¼Œä¿æŒä¸Šä¸‹æ–‡æ¸…æ´
- `auto_compact=true` â†’ å…œåº•ä¿æŠ¤ï¼Œé˜²æ­¢çœŸæ­£æº¢å‡º

## æ€§èƒ½åˆ†æ

| æ“ä½œ | é¢‘ç‡ | æˆæœ¬ | è¯´æ˜ |
|------|------|------|------|
| prune() | æ¯æ¬¡å¯¹è¯ | < 1ms | æœ‰å¤šé‡ä¿æŠ¤ï¼Œé€šå¸¸ç«‹å³è¿”å› |
| compact() | ç½•è§ | ~2-5s | éœ€è¦è°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦ |
| is_overflow() | æ¯æ¬¡å¯¹è¯ | < 1ms | ç®€å•çš„ token è®¡æ•° |

## æ€»ç»“

é‡‡ç”¨ OpenCode çš„è®¾è®¡å“²å­¦ï¼š
- âœ… **ç®€å•å°±æ˜¯ç¾** - é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£
- âœ… **ä¸»åŠ¨ç»´æŠ¤** - æŒç»­ä¿æŒä¸Šä¸‹æ–‡æ¸…æ´
- âœ… **å¤šé‡ä¿æŠ¤** - ä¸ä¼šè¯¯åˆ é‡è¦å†…å®¹
- âœ… **æ€§èƒ½ä¼˜ç§€** - prune æˆæœ¬æä½
- âœ… **åˆ†ç¦»å…³æ³¨ç‚¹** - pruneï¼ˆæ—¥å¸¸ï¼‰vs compactï¼ˆæ•‘æ´ï¼‰

ä»£ç ç®€æ´æ€§å¯¹æ¯”ï¼š
```python
# OpenCode é£æ ¼
prune()
if overflow: compact()

# vs å¤æ‚æ–¹å¼
if overflow:
    if enable_prune:
        prune()
        if still_overflow:
            compact()
    else:
        compact()
```

**ç®€å•ï¼Œä½†ä¸ç®€é™‹ã€‚** ğŸ¯
